<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lora Data Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <h1>Lora Data Dashboard</h1>
    
    <form id="filterForm">
        <label for="mode">Enter User ID:</label>
        <input type="text" id="mode" name="mode" value="{{ mode }}">
        <button type="button" onclick="fetchData()">Filter</button>
    </form>

    <div id="current-user-display" style="margin: 15px 0; font-weight: bold;">
        {% if mode %}
            Currently viewing data for mode: <span style="color: #2ecc71;">{{ mode }}</span>
        {% else %}
            No mode selected - showing all data
        {% endif %}
    </div>

    <h2>App Data</h2>
    <table id="command-table" border="1">
        <thead>
            <tr>
                <th>Time</th>
                <th>Status</th>
                <th>Command</th>
            </tr>
        </thead>
        <tbody>
            {% for item in app_data %}
            <tr>
                <td>{{ item.timestamp | datetime }}</td>
                <td>{{ item.status }}</td>
                <td>{{ item.msg }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <h2>Node Data</h2>
    <table id="status-table" border="1">
        <thead>
            <tr>
                <th>Timestamp</th>
                <th>Battery %</th>
                <th>GPS</th>
                <th>Message</th>
            </tr>
        </thead>
        <tbody>
            {% for item in node_data %}
            <tr>
                <td>{{ item.timestamp | datetime }}</td>
                <td>{{ item.battery_level }}</td>
                <td>{{ item.gps_latitude }}, {{ item.gps_longitude }}</td>
                <td>{{ item.msg }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <script>
    function fetchData() {
        const mode = document.getElementById('mode').value;
        const params = new URLSearchParams({ mode });
        
        // Update both the page URL and content
        window.history.replaceState({}, '', `?${params}`);
        
        fetch(`/api/data?${params}`)
            .then(response => response.json())
            .then(data => {
                // Update the tables with the filtered data
                updateCommandTable(data.app_data);
                updateNodeTable(data.node_data);
                
                // Update the current user display
                updateCurrentUserDisplay(mode);
            })
            .catch(error => {
                console.error('Error fetching data:', error);
            });
    }

    function updateCommandTable(appData) {
        const tbody = document.querySelector('#command-table tbody');
        if (!appData || !tbody) return;
        
        tbody.innerHTML = appData.map(item => `
            <tr>
                <td>${formatDateTime(item.timestamp)}</td>
                <td>${item.status}</td>
                <td title="${item.msg}">${item.msg}</td>
            </tr>
        `).join('');
    }

    function updateNodeTable(nodeData) {
        const tbody = document.querySelector('#status-table tbody');
        if (!nodeData || !tbody) return;
        
        tbody.innerHTML = nodeData.map(item => `
            <tr>
                <td>${formatDateTime(item.timestamp)}</td>
                <td>${item.battery_level}</td>
                <td title="${item.gps_latitude}, ${item.gps_longitude}">${item.gps_latitude}, ${item.gps_longitude}</td>
                <td title="${item.msg}">${item.msg || ''}</td>
            </tr>
        `).join('');
    }

    function updateCurrentUserDisplay(mode) {
        const display = document.getElementById('current-user-display');
        modes = ['none', 'test', 'exp']
        if (mode.lower() in modes) {
            display.innerHTML = `Currently viewing data for mode: <span style="color: #2ecc71;">${mode}</span>`;
        } 
        else if (mode){
            display.innerHTML = 'Invalid mode selected - showing all data';
            mode = None;
        }
        else {
            display.innerHTML = 'No mode selected - showing all data';
        }
    }

    function formatDateTime(timestamp) {
        // Basic client-side datetime formatting
        const date = new Date(timestamp);
        const options = { 
            year: 'numeric', month: 'short', day: 'numeric',
            hour: 'numeric', minute: '2-digit', second: '2-digit', hour12: true 
        };
        return date.toLocaleString('en-US', options);
    }

    // Auto-refresh every 5 seconds
    setInterval(fetchData, 5000);

    // Initial load
    fetchData();
    </script>
</body>
</html>